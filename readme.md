# ğŸ¬ Cinematch V2

**Cinematch V2** is an intelligent movie recommendation system that uses semantic search and vector embeddings to help you discover movies based on natural language queries like "sad robots" or "heist movie with a twist."

Built with ChromaDB for vector storage, Sentence Transformers for embeddings, and Streamlit for an interactive UI.

---

## âœ¨ Features

- **ğŸ” Semantic Search**: Search movies using natural language descriptions
- **ğŸ¯ Smart Filtering**: Filter by genre, year, rating, and content type
- **ğŸ”— Find Similar**: Discover movies similar to ones you love
- **ğŸ“Š Hybrid Ranking**: Combines semantic relevance with popularity metrics
- **âš¡ Fast & Efficient**: ChromaDB-powered vector search with caching
- **ğŸ¨ Clean UI**: Responsive Streamlit interface with movie posters

---

## ğŸ“‹ Table of Contents

1. [Prerequisites](#prerequisites)
2. [Installation](#installation)
3. [Data Preparation](#data-preparation)
4. [Building the Vector Database](#building-the-vector-database)
5. [Running the Application](#running-the-application)
6. [Architecture](#architecture)
7. [Usage Guide](#usage-guide)
8. [Troubleshooting](#troubleshooting)
9. [Advanced Configuration](#advanced-configuration)

---

## ğŸ”§ Prerequisites

- **Python**: 3.8 or higher
- **RAM**: Minimum 4GB (8GB recommended)
- **Storage**: ~2GB for vector database
- **Data Sources**:
  - TMDb movie dataset (`movies_clean.csv`)
  - IMDb dataset (`title.basics.tsv`) - Optional

---

## ğŸ“¦ Installation

### 1. Clone the Repository

```bash
git clone https://github.com/yourusername/cinematch_v2.git
cd cinematch_v2
```

### 2. Create Virtual Environment

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# macOS/Linux
python3 -m venv venv
source venv/bin/activate
```

### 3. Install Dependencies

```bash
pip install -r requirements.txt
```

**Core Dependencies:**
```
streamlit>=1.28.0
chromadb>=0.4.15
sentence-transformers>=2.2.2
pandas>=2.0.0
numpy>=1.24.0
```

---

## ğŸ“Š Data Preparation

### Project Structure

```
cinematch_v2/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ raw/                    # 1. Place downloaded files here
â”‚   â”‚   â”œâ”€â”€ movies_clean.csv    # TMDb dataset
â”‚   â”‚   â””â”€â”€ title.basics.tsv    # IMDb dataset (optional)
â”‚   â”œâ”€â”€ processed/              # 2. Generated by data_merger.py
â”‚   â”‚   â””â”€â”€ movies_merged.csv
â”‚   â””â”€â”€ chroma/                 # 3. Generated by build_vector.py
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ build_vector.py         # Vector database builder
â”‚   â”œâ”€â”€ query_engine.py         # Search & recommendation engine
â”‚   â”œâ”€â”€ chroma_manager.py       # ChromaDB wrapper
â”‚   â””â”€â”€ ...
â”œâ”€â”€ app.py                      # Streamlit frontend
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

### Step 1: Download Data

Place your TMDb dataset in `data/raw/movies_clean.csv`

**Required Columns:**
- `id` - Unique movie ID
- `title` - Movie title
- `overview` - Plot description
- `genres` - Comma-separated genre names
- `vote_average` - Rating (0-10)
- `vote_count` - Number of votes
- `release_date` - Release date
- `poster_path` - TMDb poster path
- `tagline` - Movie tagline (optional)
- `keywords` - Movie keywords (optional)
- `adult` - Adult content flag (optional)

### Step 2: Merge Data (Optional)

If using IMDb data for enrichment:

```bash
python src/data_merger.py
```

This creates `data/processed/movies_merged.csv`

---

## ğŸ—„ï¸ Building the Vector Database

### Understanding the Build Process

The vector database converts movie metadata into numerical embeddings that enable semantic search.

**What happens during build:**
1. âœ… Loads and cleans movie data
2. âœ… Generates "super strings" combining title, genres, keywords, overview
3. âœ… Creates embeddings using `all-MiniLM-L6-v2` model
4. âœ… Stores in ChromaDB with metadata for filtering
5. âœ… Creates genre one-hot encodings for fast filtering

### Build the Database

```bash
cd src
python build_vector.py
```

**Build Settings** (in `build_vector.py`):

```python
COLLECTION_NAME = "cine_match_v1"     # ChromaDB collection name
PERSIST_DIR = "./chroma_db"           # Database storage location
DATA_PATH = "path/to/movies.csv"      # Input CSV path
```

**Expected Output:**
```
ğŸ§¹ Loading and cleaning data...
   - Parsing genres...
âœ… Cleaned data: 45,466 unique movies ready.
ğŸš€ Starting ingestion of 45,466 movies...
   - Processed batch 0 to 500
   - Processed batch 500 to 1000
   ...
âœ… DONE! Collection 'cine_match_v1' built.
```

**Build Time**: ~10-15 minutes for 45,000 movies

---

## ğŸš€ Running the Application

### Start the Streamlit App

```bash
streamlit run app.py
```

The app will open in your browser at `http://localhost:8501`

### First-Time Setup

The app automatically:
- âœ… Locates the ChromaDB database
- âœ… Loads the embedding model
- âœ… Validates the collection
- âœ… Displays database statistics

---

## ğŸ—ï¸ Architecture

### System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User UI   â”‚ (Streamlit)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  app.py     â”‚ â—„â”€â”€â”€ Handles UI state & user input
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  query_engine.py     â”‚ â—„â”€â”€â”€ Search logic & ranking
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â–º search_movies()       # Text-based search
       â”œâ”€â”€â–º find_similar_movies() # Vector similarity
       â””â”€â”€â–º _fetch_popular_movies() # Fallback
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  chroma_manager.py   â”‚ â—„â”€â”€â”€ ChromaDB interface
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ChromaDB Vector DB  â”‚ â—„â”€â”€â”€ Persistent storage
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Components

#### 1. **app.py** - Frontend Layer
- Streamlit UI with sidebar filters
- Session state management for "Find Similar"
- Result display with poster cards
- User interaction handling

#### 2. **query_engine.py** - Search Engine
- **`search_movies()`**: Semantic search with filters
- **`find_similar_movies()`**: Vector-based recommendations
- **`_build_where_clause()`**: Metadata filter construction
- **`_process_results()`**: Result ranking and scoring

#### 3. **chroma_manager.py** - Database Manager
- ChromaDB client initialization
- Collection retrieval
- Database validation
- Path resolution (handles multiple locations)

#### 4. **build_vector.py** - Indexing Pipeline
- Data cleaning and preprocessing
- Genre parsing and one-hot encoding
- Super-string generation for embeddings
- Batch processing for memory efficiency

### Data Flow

**Search Query:**
```
User Query ("sad robots")
  â†“
Encode with SentenceTransformer
  â†“
Query ChromaDB (cosine similarity)
  â†“
Apply metadata filters (genres, year, rating)
  â†“
Blend semantic score + popularity
  â†“
Sort & return top N results
  â†“
Display in UI
```

**Find Similar:**
```
User clicks "Find Similar" on Interstellar
  â†“
Fetch movie's embedding from ChromaDB
  â†“
Query with that embedding vector
  â†“
Apply filters
  â†“
Exclude source movie from results
  â†“
Return similar movies
```

---

## ğŸ“– Usage Guide

### Basic Search

1. **Enter a query** in the sidebar:
   - `"time travel paradox"`
   - `"heist movie"`
   - `"sad robots"`
   - `"coming of age story"`

2. **Apply filters** (optional):
   - Genres: Select one or more
   - Year Range: Slider (1900-2025)
   - Minimum Rating: 0-10
   - Safe Search: Hide adult content

3. **View results** with:
   - Movie poster
   - Title & year
   - Rating & match percentage
   - Overview (expandable)

### Advanced Features

#### 1. Find Similar Movies
- Click **"Find Similar"** on any movie card
- Discover movies with similar themes/style
- Uses vector similarity (not genre matching)

#### 2. Sort Options
- **Relevance**: Best semantic match (default)
- **Rating**: Highest rated (min 100 votes)
- **Popularity**: Most voted
- **Newest**: Most recent releases

#### 3. Popularity Boost
- Slider: 0.0 to 0.5
- Balances semantic relevance vs popularity
- Higher = favors popular movies

### Example Queries

| Query | What It Finds |
|-------|---------------|
| `"mind-bending sci-fi"` | Inception, Interstellar, The Matrix |
| `"found footage horror"` | Blair Witch, Paranormal Activity, REC |
| `"80s action one-liners"` | Predator, Commando, Die Hard |
| `"slow burn mystery"` | Zodiac, Prisoners, Gone Girl |
| `"feel-good sports underdog"` | Rocky, Remember the Titans, Rudy |

---

## ğŸ”§ Troubleshooting

### Common Issues

#### 1. "Database not found"

**Symptoms:**
```
ğŸ”´ Database Error
Database folder not found. Searched at: ./chroma_db
```

**Solutions:**
- Verify `chroma_db/` or `data/chroma/` exists
- Check paths in `chroma_manager.py`:
  ```python
  POSSIBLE_PATHS = [
      "../data/chroma",   # If running from src/
      "./data/chroma",    # If running from root
      "./chroma_db"       # Legacy location
  ]
  ```
- Rebuild the database: `python src/build_vector.py`

#### 2. "Find Similar" returns no results

**Debug Steps:**

1. Check terminal for errors:
   ```
   DEBUG: Searching for movie_id=157336
   DEBUG: Found IDs=[]
   Error: Movie ID 157336 not found
   ```

2. Verify ID format in database:
   ```python
   # In build_vector.py, IDs are stored as strings:
   ids.append(str(row['id']))  # "157336"
   ```

3. Ensure consistent ID handling:
   - ChromaDB IDs are always strings
   - App should pass `str(movie_id)` to functions

#### 3. Slow search performance

**Optimizations:**
- Reduce `n_results` (default: 20)
- Lower `fetch_k` multiplier in query_engine.py
- Use SSD for ChromaDB storage
- Increase RAM allocation

#### 4. Model download fails

**Error:**
```
ConnectionError: Cannot download model
```

**Solution:**
```bash
# Pre-download the model
python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('all-MiniLM-L6-v2')"
```

#### 5. ImportError

**Symptoms:**
```
ModuleNotFoundError: No module named 'chromadb'
```

**Solution:**
```bash
# Ensure virtual environment is activated
pip install -r requirements.txt --upgrade
```

---

## âš™ï¸ Advanced Configuration

### Customizing Search Behavior

#### 1. Change Embedding Model

In `build_vector.py` and `query_engine.py`:

```python
# Faster, less accurate
model = SentenceTransformer('all-MiniLM-L6-v2')

# Slower, more accurate
model = SentenceTransformer('all-mpnet-base-v2')
```

**Note**: Must rebuild database after changing model!

#### 2. Adjust Ranking Weights

In `query_engine.py` â†’ `_process_results()`:

```python
# Current formula:
final_score = (sim_score * (1 - boost_weight)) + (norm_pop * boost_weight)

# Emphasize recency:
recency_score = (release_year - 1900) / (2025 - 1900)
final_score = sim_score * 0.7 + norm_pop * 0.2 + recency_score * 0.1
```

#### 3. Modify Super-String Template

In `build_vector.py` â†’ `generate_super_string()`:

```python
# Current (title-heavy):
return (
    f"Title: {row['title']}. Title: {row['title']}. "
    f"Genres: {row['genres_display']}. "
    f"Keywords: {row['keywords']}. "
    f"Overview: {row['overview']}"
)

# Alternative (keyword-heavy):
return (
    f"Keywords: {row['keywords']}. "
    f"Plot: {row['overview']}. "
    f"Title: {row['title']}."
)
```

#### 4. Add Custom Filters

In `query_engine.py` â†’ `_build_where_clause()`:

```python
# Add runtime filter
if filters.get('max_runtime'):
    where_conditions.append({"runtime": {"$lte": filters['max_runtime']}})

# Add language filter
if filters.get('language'):
    where_conditions.append({"original_language": filters['language']})
```

Then add UI controls in `app.py`:

```python
max_runtime = st.slider("Max Runtime (minutes)", 60, 240, 180)
language = st.selectbox("Language", ["en", "es", "fr", "de"])
```

### Performance Tuning

#### Memory Optimization

```python
# In build_vector.py - reduce batch size
batch_size = 250  # Default: 500
```

#### Query Optimization

```python
# In query_engine.py - limit over-fetching
fetch_k = n_results * 3  # Default: * 5
```

---

## ğŸ§ª Testing

### Validate Database

```python
from src.chroma_manager import validate_database

valid, message = validate_database()
print(message)
```

### Test Search Function

```python
from src.query_engine import search_movies

results = search_movies(
    query="space exploration",
    filters={"genres": [878], "min_rating": 7.0},
    n_results=10
)

for movie in results:
    print(f"{movie['title']} - Match: {movie['match_percentage']}%")
```

### Test Find Similar

```python
from src.query_engine import find_similar_movies

# Interstellar's TMDb ID
similar = find_similar_movies(movie_id=157336, n_results=10)

for movie in similar:
    print(f"{movie['title']} ({movie['release_year']})")
```

---

## ğŸ“ Development Notes

### Adding New Features

1. **New Filter Type**: 
   - Update `_build_where_clause()` in query_engine.py
   - Add metadata field in build_vector.py
   - Add UI control in app.py

2. **New Search Mode**:
   - Add function to query_engine.py
   - Create button/toggle in app.py
   - Update session state handling

3. **UI Enhancement**:
   - Modify CSS in app.py `st.markdown()` block
   - Add new columns for movie cards
   - Implement new widgets

### Code Style

- **Functions**: snake_case (`search_movies`)
- **Classes**: PascalCase (not used in current version)
- **Constants**: UPPER_CASE (`COLLECTION_NAME`)
- **Private functions**: _leading_underscore (`_process_results`)

---

## ğŸ¤ Contributing

Contributions welcome! Areas for improvement:

- [ ] Add user ratings/favorites persistence
- [ ] Implement collaborative filtering
- [ ] Add movie trailers/images
- [ ] Support multiple languages
- [ ] Add cast/crew search
- [ ] Export recommendation lists
- [ ] A/B testing for ranking algorithms

---

## ğŸ“„ License

MIT License - See LICENSE file for details

---

## ğŸ™ Acknowledgments

- **TMDb** - Movie metadata and posters
- **ChromaDB** - Vector database
- **Sentence Transformers** - Embedding models
- **Streamlit** - UI framework

---

## ğŸ“§ Support

For issues, questions, or suggestions:
- Open an issue on GitHub
- Check the [Troubleshooting](#troubleshooting) section
- Review ChromaDB docs: https://docs.trychroma.com/

---

**Built with â¤ï¸ for movie lovers**
